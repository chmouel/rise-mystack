#!/bin/bash
set -e
SWIFT_DATA_DIR=/opt/stack/data/swift

sudo mkdir -p /var/run/swift
sudo chown -R $USER: /var/run/swift

if screen -ls | egrep -q "[0-9].stack"; then
    killall screen
fi

swift-init all stop || true
pkill -9 -f swift- || true

if egrep -q ${SWIFT_DATA_DIR}/drives/sdb1 /proc/mounts;then
    sudo fuser -k ${SWIFT_DATA_DIR}/drives/sdb1 || true
    sudo umount -f ${SWIFT_DATA_DIR}/drives/sdb1
fi

mkfs.xfs -f -i size=1024 ${SWIFT_DATA_DIR}/drives/images/swift.img
sudo mount -t xfs -o loop,noatime,nodiratime,nobarrier,logbufs=8 ${SWIFT_DATA_DIR}/drives/images/swift.img ${SWIFT_DATA_DIR}/drives/sdb1
sudo chown -R ${USER} ${SWIFT_DATA_DIR}/drives/sdb1
mkdir -p ${SWIFT_DATA_DIR}/drives/sdb1/{1..3}

swift-init all start 
swift-init proxy stop 

cd ~/devstack
exec screen -e \`1 -c ./stack-screenrc
